# 開発からの学びと課題 (Lessons Learned)

このドキュメントは、LINE Googleカレンダー連携 AIエージェント開発プロジェクトを通じて得られた重要な学びと、直面した課題をまとめたものです。GCP本番環境を見据えた今後の開発プロセス改善、要件定義、設計に活かすことを目的とします。

## 1. 環境構築・管理

- **課題:** ローカル開発環境とGCP Cloud Run本番環境の差異、特に環境変数の扱いがデプロイ時の問題を引き起こした (`DATABASE_TYPE` が正しく認識されない等)。
- **学び:**
    - 開発初期段階から本番環境に近い環境（Dockerコンテナ）でテストすることの重要性。
    - 環境変数管理の一元化と、アプリケーション起動時の読み込み順序・タイミングの明確化が必要。
    - `.env` ファイルの管理（開発用、本番用）と、それらを切り替える仕組みの標準化。 **特にCloud Runでは、環境変数がビルド時ではなく実行時に設定されることを意識し、アプリケーション起動シーケンス内で環境変数に依存する処理（設定ファイルの読み込み、DB接続など）のタイミングに注意する。** (`DATABASE_TYPE` 問題の再発防止)
    - **注意点:** 環境変数の設定がキャッシュされる場合があるため、変更後はアプリケーションの完全な再起動（Cloud Runなら新しいリビジョンのデプロイ）が必要な場合がある (`reload_env.py` のようなスクリプトが必要になった経緯)。
- **課題:** Python仮想環境、多数の依存関係、特定のライブラリ（`wrapt`）へのパッチ適用など、環境構築手順が複雑化。
- **学び:**
    - Dockerfileによる環境構築の完全自動化と再現性確保が不可欠。 **`wrapt` のような特定のライブラリへのパッチ適用が必要な場合、Dockerfile内でパッチ適用スクリプトを実行するように組み込む。**
    - 依存関係は `requirements.txt` で厳密にバージョン管理する。
- **課題:** `ngrok` は一時的なWebhookテストには有効だが、永続的なテスト環境としては不安定。
- **学び:** GCP上にステージング環境（Cloud Runの別サービスや開発用プロジェクトなど）を構築し、より本番に近い状態での継続的なテストを行うことが望ましい。

## 2. API・SDK連携

- **課題:** LINE Bot SDK (v3への移行)、Google Calendar API、OpenAI Agents SDKは、バージョンアップや仕様変更が頻繁にあり、追従が必要。ドキュメントの精読と正確な実装が求められる。
- **学び:**
    - 各SDK/APIの公式ドキュメントを常に参照し、変更点を把握する体制が必要。
    - SDKの初期化方法、必須パラメータ、エラーハンドリング方法などは特に注意深く確認する。
    - 依存ライブラリのバージョンアップは慎重に行い、互換性テストを実施する。 **特にメジャーバージョンアップ時は破壊的変更が含まれる可能性が高いため、リリースノートを熟読し、影響範囲を特定する。** (LINE Bot SDK v2 -> v3移行時の `ApiClient` 初期化方法変更、メソッド名変更 (`get_default_copy` -> `get_default`) などが該当)
    - **注意点:** SDKの初期化方法や設定オブジェクトの仕様が変更されることがある。 (LINE Bot SDK v3での `Configuration` オブジェクト必須化など) ドキュメント通りの正確な実装が求められる。
- **課題:** OAuth 2.0認証フローの実装は複雑で、トークン（アクセストークン、リフレッシュトークン）の安全な管理（保存、更新、失効処理）が重要。
- **学び:**
    - 認証フローは独立したモジュールとして設計し、テスト容易性を高める。 **PKCEフローの採用を推奨。**
    - トークンは暗号化して保存し、GCP Secret Managerなどのセキュアなサービスを利用する。
    - トークンの有効期限切れを検知し、自動更新する仕組みを確実に実装する。
- **課題:** 外部APIにはレート制限があり、考慮せずに実装すると予期せぬエラーが発生する。
- **学び:**
    - API呼び出し回数を最適化する（キャッシュ活用、バッチ処理など）。
    - レート制限エラーを検知し、指数バックオフなどのリトライ戦略を実装する。

## 3. アプリケーション設計・実装

- **課題:** 設定ファイル (`settings.py`) の読み込みタイミングやバリデーションロジックが、環境変数関連の問題の一因となった。
- **学び:**
    - 設定情報はアプリケーション起動の早い段階で一度だけ読み込み、イミュータブルなオブジェクトとして扱う。
    - 設定値のバリデーションは起動時に行い、不正な場合は早期にエラーとする。 **設定クラス (`settings.py` など) 内での環境変数依存のバリデーションロジックは、環境変数が読み込まれた後に実行されるように注意する。** (`DATABASE_TYPE` 問題の再発防止)
- **課題:** リマインダー機能のような非同期処理やバックグラウンドタスクは、デバッグや状態管理が難しい。 (リマインダー同期問題、ユーザーアクティブ状態の問題などが発生)
- **学び:**
    - 非同期タスクの実行基盤（APScheduler, Celery, Cloud Tasks/Schedulerなど）を慎重に選定・設計する。 **GCP環境ではCloud Tasks/Schedulerの利用を推奨。**
    - タスクの状態（待機中、実行中、完了、失敗）を記録し、監視・追跡可能にする。
    -冪等性（複数回実行しても結果が変わらないこと）を意識した設計にする。
- **課題:** データベースの移行（SQLite → Firestore）は、データモデルの変更やクエリの書き換えなど、多くの作業を伴う。
- **学び:**
    - データアクセス層を抽象化（リポジトリパターンなど）し、データベース技術への依存を低減する。
    - 移行計画を早期に立て、データ移行スクリプトやテストを準備する。
- **課題:** 自然言語（特に日本語）の日時表現は多様で曖昧さも多く、完全な解析は困難。
- **学び:**
    - 正規表現やライブラリを活用しつつ、対応可能なパターンを明確にする。
    - 解析できなかった場合や曖昧な場合に、ユーザーに確認を求める対話フローを設計する。
    - OpenAI Agents SDKのような高度なAIモデルを活用し、解析能力を向上させる。 **ただし、SDKのバージョン互換性には注意が必要。** (v0.0.9でのクラス初期化エラー発生の経緯)
- **学び:** 堅牢なエラーハンドリング（try-except）と詳細なロギングは、問題発生時の原因特定と迅速な復旧に不可欠。 **特に外部API連携部分や非同期処理部分では、予期せぬエラーに備え、詳細なコンテキスト情報（入力値、状態など）を含むログを出力する。**
- **注意点:** Pythonの循環インポート問題。モジュール間の依存関係が複雑になると発生しやすい。インポートの仕方（関数内インポートなど）や設計の見直しで回避する。 (LINE Bot SDKクライアント初期化時の問題)
- **注意点:** コードの構文エラー（特にインデントミス）は基本的な問題だが、見落とすとアプリケーションが起動しない原因となる。Lintツール (flake8) の活用とレビューで防止する。 (reminder_service.pyでの構文エラー)

## 4. テストとデプロイ

- **課題:** Cloud Runへの手動デプロイは手順が煩雑で、ミスが発生しやすい。環境変数設定の反映漏れなどが問題となった。
- **学び:**
    - CI/CDパイプライン（GitHub Actionsなど）を構築し、テスト、ビルド、デプロイを自動化する。
    - Dockerイメージのビルドプロセスで環境固有の設定を埋め込まないようにする（実行時に環境変数で注入）。
- **課題:** ローカルと本番の環境差異により、ローカルで成功したテストが本番で失敗することがある。
- **学び:**
    - Dockerコンテナ内でのテスト実行を標準とする。
    - 外部API連携部分はモックやスタブを活用した単体・結合テストに加え、ステージング環境でのE2Eテストを実施する。
- **課題:** リッチメニュー更新など、外部サービスの設定変更を伴う機能のテストは難しい。
- **学び:**
    - 設定変更APIをテストするための専用スクリプトやテストアカウントを用意する。
    - 変更操作を冪等にするか、元に戻す手順を確立する。 **リッチメニュー更新スクリプト (`recreate_rich_menu.py`, `reset_rich_menu.py`) のような管理用スクリプトを用意しておくと、問題発生時の切り分けや復旧に役立つ。**

## 5. 開発プロセス

- **学び:** Memory Bankシステムは、プロジェクトの知識やコンテキストを効果的に継承するために非常に有効。継続的な更新が重要。
- **学び:** README、CHANGELOG、各種設計・手順ガイドなどのドキュメントは、開発効率とメンテナンス性を高める上で不可欠。常に最新の状態に保つ。
- **学び:** 小さな単位で機能を実装し、テストとレビューを繰り返すイテレーティブな開発プロセスが、複雑なシステム開発に適している。
